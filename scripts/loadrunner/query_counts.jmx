<?xml version="1.0" encoding="UTF-8"?>
<jmeterTestPlan version="1.2" properties="5.0" jmeter="5.1.1 r1855137">
  <hashTree>
    <TestPlan guiclass="TestPlanGui" testclass="TestPlan" testname="Test Plan" enabled="true">
      <stringProp name="TestPlan.comments"></stringProp>
      <boolProp name="TestPlan.functional_mode">false</boolProp>
      <boolProp name="TestPlan.tearDown_on_shutdown">true</boolProp>
      <boolProp name="TestPlan.serialize_threadgroups">false</boolProp>
      <elementProp name="TestPlan.user_defined_variables" elementType="Arguments" guiclass="ArgumentsPanel" testclass="Arguments" testname="User Defined Variables" enabled="true">
        <collectionProp name="Arguments.arguments"/>
      </elementProp>
      <stringProp name="TestPlan.user_define_classpath"></stringProp>
    </TestPlan>
    <hashTree>
      <ThreadGroup guiclass="ThreadGroupGui" testclass="ThreadGroup" testname="DremioQueryCounts" enabled="true">
        <stringProp name="ThreadGroup.on_sample_error">continue</stringProp>
        <elementProp name="ThreadGroup.main_controller" elementType="LoopController" guiclass="LoopControlPanel" testclass="LoopController" testname="Loop Controller" enabled="true">
          <boolProp name="LoopController.continue_forever">false</boolProp>
          <stringProp name="LoopController.loops">1</stringProp>
        </elementProp>
        <stringProp name="ThreadGroup.num_threads">1</stringProp>
        <stringProp name="ThreadGroup.ramp_time">1</stringProp>
        <boolProp name="ThreadGroup.scheduler">false</boolProp>
        <stringProp name="ThreadGroup.duration"></stringProp>
        <stringProp name="ThreadGroup.delay"></stringProp>
      </ThreadGroup>
      <hashTree>
        <BeanShellSampler guiclass="BeanShellSamplerGui" testclass="BeanShellSampler" testname="BeanShell Sampler" enabled="true">
          <stringProp name="BeanShellSampler.query">import java.nio.file.Files; 
import java.nio.charset.Charset;
import org.apache.commons.io.FileUtils;
import org.apache.jmeter.services.FileServer;
try {

	//The queries folder should be located relative to the Directory that contains the jmx file
	//Fetch parent directory of the JMX file
	projectHome = FileServer.getFileServer().getBaseDir();

	log.info(&quot;${__P(query_dir)}&quot;);

	String queryDirectory = projectHome + &quot;/&quot; + &quot;${__P(query_dir)}&quot;;
	log.info(queryDirectory);
	File folder = new File(queryDirectory);

	//Unique batch_id (current timestamp) is generated for each Jmeter batch execution. 
	//All queries in that batch would get the same Batch_id/Test_id

	String test_id = String.valueOf(${__P(batch_id)});
	String test_id_prefix = &quot;--Test-&quot; + test_id;
	String query_header_comments = test_id_prefix + &quot;|COUNT&quot;;
	
	// Clear out the counts_summary.csv and query_counts.csv file
	FileWriter fstream1 = new FileWriter(&quot;../../logs/counts_summary.csv&quot;,false);
	fstream1.close();
	FileWriter fstream2 = new FileWriter(&quot;../../logs/query_counts.csv&quot;,false);
	fstream2.close();

	log.info(&quot;---------------------------------------------------------------&quot;);
	log.info(&quot;--------------***   STARTING COUNT TESTING   ***---------------&quot;);
	log.info(&quot;---------------------------------------------------------------&quot;);

	File[] sqlFiles = folder.getCanonicalFile().listFiles();

	Arrays.sort(sqlFiles);
	int sourceFileCount = sqlFiles.length;

	for (int i = 0; i &lt; sqlFiles.length; i++) {
    		File sqlFile = sqlFiles[i].getCanonicalFile();
	
	//Prepend to each query the unique batch_id as a comment (i.e. &quot;--TEST-123&quot;). That helps us later fetching all queries within a certain batch. 
    		//Each query is stored in a separate variable: q_1,q_2...q_n 	
    		if (sqlFile.isFile()) {
			String queryNum = sqlFile.getName().replaceAll(&quot;.sql&quot;, &quot;&quot;);
			//String orig_sql_text = FileUtils.readFileToString(sqlFile); //This call doesn&apos;t work for sym links
			String orig_sql_text = &quot;&quot;;
          	List lines = Files.readAllLines(sqlFile.getCanonicalFile().toPath(), Charset.defaultCharset());
          	for (String line:lines) {
          		orig_sql_text += line;
        		}
		
			// Wrap the query in select count(*) from....
			orig_sql_text = &quot;SELECT &apos;Q&quot; + queryNum + &quot;&apos;, COUNT(*) FROM (&quot; + orig_sql_text + &quot;)&quot;;
			String final_sql = orig_sql_text;//.replaceAll(&quot;&lt;jmeter_suffix&gt;&quot;,test_id + &quot;_&quot; + i).replaceAll(&quot;&lt;jmeter_ctas_directory&gt;&quot;,ctas_directory);
          	vars.put(&quot;q_&quot; + i, &quot;--Q&quot; + queryNum + &quot; &quot; + query_header_comments + &quot;|counter-&quot; + i +  &quot;\r\n&quot; + final_sql);
    		}

	}

}
catch (Throwable ex) {
    log.error(&quot;run_counts Beanshell failure: &quot;, ex);
	System.out.println(&quot;run_counts Beanshell failure: &quot;, ex);
    throw ex;
}</stringProp>
          <stringProp name="BeanShellSampler.filename"></stringProp>
          <stringProp name="BeanShellSampler.parameters"></stringProp>
          <boolProp name="BeanShellSampler.resetInterpreter">false</boolProp>
        </BeanShellSampler>
        <hashTree/>
        <JDBCDataSource guiclass="TestBeanGUI" testclass="JDBCDataSource" testname="Dremio-JDBC" enabled="true">
          <boolProp name="autocommit">true</boolProp>
          <stringProp name="checkQuery">select 1</stringProp>
          <stringProp name="connectionAge">5000</stringProp>
          <stringProp name="dataSource">dremiopool</stringProp>
          <stringProp name="dbUrl">jdbc:dremio:direct=${__P(dremio_host)}:31010</stringProp>
          <stringProp name="driver">com.dremio.jdbc.Driver</stringProp>
          <stringProp name="initQuery"></stringProp>
          <boolProp name="keepAlive">true</boolProp>
          <stringProp name="password">${__P(password)}</stringProp>
          <stringProp name="poolMax">1</stringProp>
          <stringProp name="timeout">10000</stringProp>
          <stringProp name="transactionIsolation">DEFAULT</stringProp>
          <stringProp name="trimInterval">60000</stringProp>
          <stringProp name="username">${__P(username)}</stringProp>
        </JDBCDataSource>
        <hashTree/>
        <ForeachController guiclass="ForeachControlPanel" testclass="ForeachController" testname="ForEach Controller" enabled="true">
          <stringProp name="ForeachController.inputVal">q</stringProp>
          <stringProp name="ForeachController.returnVal">query</stringProp>
          <boolProp name="ForeachController.useSeparator">true</boolProp>
          <stringProp name="ForeachController.startIndex">-1</stringProp>
        </ForeachController>
        <hashTree>
          <JDBCSampler guiclass="TestBeanGUI" testclass="JDBCSampler" testname="dremio query" enabled="true">
            <stringProp name="dataSource">dremiopool</stringProp>
            <stringProp name="query">${query}</stringProp>
            <stringProp name="queryArguments"></stringProp>
            <stringProp name="queryArgumentsTypes"></stringProp>
            <stringProp name="queryTimeout"></stringProp>
            <stringProp name="queryType">Select Statement</stringProp>
            <stringProp name="resultSetHandler">Count Records</stringProp>
            <stringProp name="resultVariable"></stringProp>
            <stringProp name="variableNames">queryId,rowCount</stringProp>
          </JDBCSampler>
          <hashTree/>
          <BeanShellPostProcessor guiclass="TestBeanGUI" testclass="BeanShellPostProcessor" testname="BeanShell PostProcessor" enabled="true">
            <stringProp name="filename"></stringProp>
            <stringProp name="parameters"></stringProp>
            <boolProp name="resetInterpreter">false</boolProp>
            <stringProp name="script">FileWriter fstream = new FileWriter(&quot;../../logs/query_counts.csv&quot;,true);
BufferedWriter out = new BufferedWriter(fstream);
out.write(vars.get(&quot;queryId_1&quot;) + &quot;,&quot; +
		vars.get(&quot;rowCount_1&quot;));
out.write(System.getProperty(&quot;line.separator&quot;));
out.close();
fstream.close();</stringProp>
          </BeanShellPostProcessor>
          <hashTree/>
        </hashTree>
        <ResultCollector guiclass="SummaryReport" testclass="ResultCollector" testname="Summary Report" enabled="true">
          <boolProp name="ResultCollector.error_logging">false</boolProp>
          <objProp>
            <name>saveConfig</name>
            <value class="SampleSaveConfiguration">
              <time>true</time>
              <latency>true</latency>
              <timestamp>true</timestamp>
              <success>true</success>
              <label>true</label>
              <code>true</code>
              <message>true</message>
              <threadName>true</threadName>
              <dataType>true</dataType>
              <encoding>false</encoding>
              <assertions>true</assertions>
              <subresults>true</subresults>
              <responseData>false</responseData>
              <samplerData>false</samplerData>
              <xml>false</xml>
              <fieldNames>true</fieldNames>
              <responseHeaders>false</responseHeaders>
              <requestHeaders>false</requestHeaders>
              <responseDataOnError>false</responseDataOnError>
              <saveAssertionResultsFailureMessage>true</saveAssertionResultsFailureMessage>
              <assertionsResultsToSave>0</assertionsResultsToSave>
              <bytes>true</bytes>
              <sentBytes>true</sentBytes>
              <url>true</url>
              <threadCounts>true</threadCounts>
              <idleTime>true</idleTime>
              <connectTime>true</connectTime>
            </value>
          </objProp>
          <stringProp name="filename">../../logs/counts_summary.csv</stringProp>
          <boolProp name="useGroupName">true</boolProp>
        </ResultCollector>
        <hashTree/>
        <ResultCollector guiclass="ViewResultsFullVisualizer" testclass="ResultCollector" testname="View Results Tree" enabled="true">
          <boolProp name="ResultCollector.error_logging">false</boolProp>
          <objProp>
            <name>saveConfig</name>
            <value class="SampleSaveConfiguration">
              <time>true</time>
              <latency>true</latency>
              <timestamp>true</timestamp>
              <success>true</success>
              <label>true</label>
              <code>true</code>
              <message>true</message>
              <threadName>true</threadName>
              <dataType>true</dataType>
              <encoding>false</encoding>
              <assertions>true</assertions>
              <subresults>true</subresults>
              <responseData>false</responseData>
              <samplerData>false</samplerData>
              <xml>false</xml>
              <fieldNames>true</fieldNames>
              <responseHeaders>false</responseHeaders>
              <requestHeaders>false</requestHeaders>
              <responseDataOnError>false</responseDataOnError>
              <saveAssertionResultsFailureMessage>true</saveAssertionResultsFailureMessage>
              <assertionsResultsToSave>0</assertionsResultsToSave>
              <bytes>true</bytes>
              <sentBytes>true</sentBytes>
              <url>true</url>
              <threadCounts>true</threadCounts>
              <idleTime>true</idleTime>
              <connectTime>true</connectTime>
            </value>
          </objProp>
          <stringProp name="filename"></stringProp>
        </ResultCollector>
        <hashTree/>
        <ResultCollector guiclass="StatVisualizer" testclass="ResultCollector" testname="Aggregate Report" enabled="true">
          <boolProp name="ResultCollector.error_logging">false</boolProp>
          <objProp>
            <name>saveConfig</name>
            <value class="SampleSaveConfiguration">
              <time>true</time>
              <latency>true</latency>
              <timestamp>true</timestamp>
              <success>true</success>
              <label>true</label>
              <code>true</code>
              <message>true</message>
              <threadName>true</threadName>
              <dataType>true</dataType>
              <encoding>false</encoding>
              <assertions>true</assertions>
              <subresults>true</subresults>
              <responseData>false</responseData>
              <samplerData>false</samplerData>
              <xml>false</xml>
              <fieldNames>true</fieldNames>
              <responseHeaders>false</responseHeaders>
              <requestHeaders>false</requestHeaders>
              <responseDataOnError>false</responseDataOnError>
              <saveAssertionResultsFailureMessage>true</saveAssertionResultsFailureMessage>
              <assertionsResultsToSave>0</assertionsResultsToSave>
              <bytes>true</bytes>
              <sentBytes>true</sentBytes>
              <url>true</url>
              <threadCounts>true</threadCounts>
              <idleTime>true</idleTime>
              <connectTime>true</connectTime>
            </value>
          </objProp>
          <stringProp name="filename"></stringProp>
        </ResultCollector>
        <hashTree/>
      </hashTree>
    </hashTree>
  </hashTree>
</jmeterTestPlan>
